#include <iostream>
#include <SDL2/SDL.h>
#include <vector>
#include <algorithm>
#include <cmath>

const int WIDTH  = 175;
const int HEIGHT = 175;


enum class CellType{
  Empty,
  Sand,
  WetSand,
  Water,
  Oil
};

void updateParticle(CellType grid[WIDTH][HEIGHT]);




const double PI = 3.14159;

int main (int argc, char *argv[]) {
  double deltaTime = 1.0 / 60.0;

if(SDL_Init(SDL_INIT_VIDEO) != 0) {
        std::cerr << "SDL_Init Error: " << SDL_GetError() << std::endl;
        return 1;
}
  
int window_width = 700;
int window_height = 700;

     // Create a window
    SDL_Window* window = SDL_CreateWindow(
        "Sand Simulation",
        SDL_WINDOWPOS_CENTERED,
        SDL_WINDOWPOS_CENTERED,
        window_width,
        window_height,
        SDL_WINDOW_SHOWN
    );

    if (!window) {
        std::cerr << "SDL_CreateWindow Error: " << SDL_GetError() << std::endl;
        SDL_Quit();
        return 1;
    }

    SDL_Renderer* renderer = SDL_CreateRenderer(window, -1, SDL_RENDERER_ACCELERATED);
    if (!renderer) {
        std::cerr << "Renderer could not be created! SDL_Error: " << SDL_GetError() << std::endl;
        SDL_DestroyWindow(window);
        SDL_Quit();
        return 1;
    }

//particle colors
SDL_Color wetSandColor = {178, 164, 93, 255};
SDL_Color sandColor = {255, 211, 106, 255};
SDL_Color waterColor = {41, 104, 255, 200};
SDL_Color oilColor = {75, 22, 7, 200};



//grid
const int cellSize = 4;
CellType grid[WIDTH][HEIGHT] = {};


bool running = true;
SDL_Event event;
while (running){
  CellType chosenCell;

  while (SDL_PollEvent(&event)) {
    if (event.type == SDL_QUIT) {
      running = false;
    }


    if(event.type == SDL_KEYDOWN && event.key.keysym.sym == SDLK_1) chosenCell = CellType::Sand;
    if(event.type == SDL_KEYDOWN && event.key.keysym.sym == SDLK_2) chosenCell = CellType::WetSand;
    if(event.type == SDL_KEYDOWN && event.key.keysym.sym == SDLK_3) chosenCell = CellType::Water;
    if(event.type == SDL_KEYDOWN && event.key.keysym.sym == SDLK_4) chosenCell = CellType::Oil;

  }
  int mouseX;
  int mouseY;
  Uint32 mouseState = SDL_GetMouseState(&mouseX, &mouseY);
 

  if ( mouseState & SDL_BUTTON(SDL_BUTTON_LEFT)) {
    double circle_radius = 5;

    // Convert to grid coordinates
    int gridX = mouseX / cellSize;
    int gridY = mouseY / cellSize;

    // Safety check
    if (gridX >= 0 && gridX < 175 && gridY >= 0 && gridY < 175) {
      int r2 = circle_radius * circle_radius; // radius squared
      for (int i = -circle_radius; i <= circle_radius; i++) {
        for (int j = -circle_radius; j <= circle_radius; j++) {
          int x = gridX + j;
          int y = gridY + i;
          if (x >= 0 && x < 175 && y >= 0 && y < 175) {
            if (i * i + j * j <= r2) { // inside circle
              grid[x][y] = chosenCell;
            }
          }
        }
      }
    }

  }


//update particles
  updateParticle(grid);

  for(int i = 0; i < 4; i++){
    for(int x = 0; x < WIDTH; x++){
      for(int y = 0; y < HEIGHT; y++){


        //swaps sand and liquids
        if((grid[x][y] == CellType::Sand || grid[x][y] == CellType::WetSand) && (grid[x][y + 1] == CellType::Water || grid[x][y + 1] == CellType::Oil)){
          CellType tempCell = grid[x][y + 1];
          grid[x][y] = CellType::Empty;
          grid[x][y + 1] = CellType::Empty;

          grid[x][y] = tempCell;
          grid[x][y + 1] = CellType::WetSand;
          break;
        }


        //swaps water and oil
        if((grid[x][y] == CellType::Water) && (grid[x][y + 1] == CellType::Oil)){
          grid[x][y] = CellType::Empty;
          grid[x][y + 1] = CellType::Empty;

          grid[x][y] = CellType::Oil;
          grid[x][y + 1] = CellType::Water;
          break;
        }


        //turns sand into wet sand if its touching water
        if(grid[x][y] == CellType::Sand){
          if(
              (y + 1 < HEIGHT && grid[x][y + 1] == CellType::Water) ||
              (y - 1 > 0 && grid[x][y - 1] == CellType::Water) ||
              (x + 1 < WIDTH && grid[x + 1][y] == CellType::Water) || 
              (x - 1 > 0 && grid[x - 1][y] == CellType::Water)
            ){grid[x][y] = CellType::WetSand;}
        }



      }
    } 
  }



SDL_SetRenderDrawColor(renderer, 0, 0, 0, 255);
SDL_RenderClear(renderer);

for(int x = 0; x < WIDTH; x++){
  for(int y = 0; y < HEIGHT; y++){
    if(grid[x][y] == CellType::Sand){
      SDL_SetRenderDrawColor(renderer, sandColor.r, sandColor.g, sandColor.b, sandColor.a);
      int pixelX = x * cellSize;
      int pixelY = y * cellSize;
      SDL_Rect rect = { pixelX, pixelY, cellSize, cellSize };

      SDL_RenderFillRect(renderer, &rect);
    }
    else if(grid[x][y] == CellType::Water){
      SDL_SetRenderDrawColor(renderer, waterColor.r, waterColor.g, waterColor.b, waterColor.a);

      int pixelX = x * cellSize;
      int pixelY = y * cellSize;
      SDL_Rect rect = { pixelX, pixelY, cellSize, cellSize };

      SDL_RenderFillRect(renderer, &rect);
    }
    else if(grid[x][y] == CellType::WetSand){
      SDL_SetRenderDrawColor(renderer, wetSandColor.r, wetSandColor.g, wetSandColor.b, wetSandColor.a);

      int pixelX = x * cellSize;
      int pixelY = y * cellSize;
      SDL_Rect rect = { pixelX, pixelY, cellSize, cellSize };

      SDL_RenderFillRect(renderer, &rect);
    }
    else if(grid[x][y] == CellType::Oil){
      SDL_SetRenderDrawColor(renderer, oilColor.r, oilColor.g, oilColor.b, oilColor.a);

      int pixelX = x * cellSize;
      int pixelY = y * cellSize;
      SDL_Rect rect = { pixelX, pixelY, cellSize, cellSize };

      SDL_RenderFillRect(renderer, &rect);
    }
  }
}


    SDL_RenderPresent(renderer);
    SDL_Delay(10); // ~60 FPS
  }


SDL_DestroyRenderer(renderer);
SDL_DestroyWindow(window);
SDL_Quit();
  return 0;
}



void updateParticle(CellType grid[WIDTH][HEIGHT]){
  //check below
  for(int x = 0; x < WIDTH; x++){
    for(int y = HEIGHT - 2; y >= 0; y--){
      CellType CELLTYPE = grid[x][y];

      if(y + 1 < HEIGHT && grid[x][y + 1] == CellType::Empty){
        if(CELLTYPE != CellType::Empty){
          grid[x][y] = CellType::Empty;
          grid[x][y + 1] = CELLTYPE;
          continue;
        }
      }

  //check left and right
  if(CELLTYPE == CellType::Sand || CELLTYPE == CellType::WetSand){
    if((rand() % 100) < 70){
      continue;
    }
  }

  bool rightFirst;
  if((rand() % 100) < 50){
    rightFirst = true;
  }
  else{
    rightFirst = false;
  }

      if(rightFirst){
        if(CELLTYPE != CellType::Empty && + 1 < WIDTH && y + 1 < HEIGHT && grid[x + 1][y + 1] == CellType::Empty){
          if(CELLTYPE != CellType::Empty){
            grid[x][y] = CellType::Empty;
            grid[x + 1][y + 1] = CELLTYPE;
            continue;
          }
        }
      }
        else{
          if(x - 1 > 0 && y + 1 < HEIGHT && grid[x - 1][y + 1] == CellType::Empty){
            if(CELLTYPE != CellType::Empty){
              grid[x][y] = CellType::Empty;
              grid[x - 1][y + 1] = CELLTYPE;
              continue;
            }
          }

        }

  int timesMoving = 1;
  bool leftFirst = rand() & 1;
  if(CELLTYPE == CellType::Oil){
    if((rand() % 100) < 65){
      continue;
    }
  }
  //check sideways for liquids
      if(CELLTYPE == CellType::Water || CELLTYPE == CellType::Oil){
        if(leftFirst){
          if(x - 1 >= 0 && grid[x - 1][y] == CellType::Empty){
            grid[x][y] = CellType::Empty;
            grid[x - 1][y] = CELLTYPE;
            continue;
          }
        }
        else{
          if(x + 1 < WIDTH && grid[x + 1][y] == CellType::Empty){
            grid[x][y] = CellType::Empty;
            grid[x + 1][y] = CELLTYPE;
            continue;
          }
        }
      }
    }
  }
}
